#CubeMX配置SPI

> [参考博客](https://blog.csdn.net/weixin_41082463/article/details/104952605)

##CubeMX具体参数配置

###SPI基本设置

和串口一样，SPI的外设配置一样是在CubeMX的**Connectivity**一栏中，我们随意打开一个SPI，可以看到可以配置如下模式：

|         模式         |     含义     |
| :------------------: | :----------: |
|  Full-Duplex Master  | 全双工主模式 |
|  Full-Duplex Slave   | 全双工从模式 |
|  Half-Duplex Master  | 半双工主模式 |
|  Half-Duplex Slave   | 半双工从模式 |
| Receive Only Master  | 仅接收主模式 |
|  Receive Only Slave  | 仅接收从模式 |
| Transmit Only Master | 仅发送主模式 |
| Transmit Only Slave  | 仅发送从模式 |

可以看到，可以按照是否双向通信，双向通信的类型，以及主机\从机进行换分：

- **全双工：** 可以**同时**进行发送和接收
- **半双工：** 可以**分时**进行发送和接收
- **从机和主机：**通信时的**时钟线**由主机控制

选择好通信模式后可以对相应参数进行配置：

![SPI参数](assets\SPI参数.png)

我们主要关注以下几个参数：

| 参数                        | 设置                                       |
| --------------------------- | ------------------------------------------ |
| Frame Format（帧格式）      | 可以设置摩托罗拉和TI，默认Motorola         |
| Data Size（数据长度）       | 根据情况选择4/8/16bit，默认为8Bits         |
| First Bit（首位翻转）       | 决定数据是高位还是在前，默认MSB First      |
| Prescaler（分频系数）       | 设置分频数调整SPI时钟速率，视情况调整      |
| NSS Signal Type（片选方式） | 可以选择软件或硬件，为自定义任意引脚选软件 |

前三个参数通常默认设置即可，而分屏系数需要注意，请看下一节的介绍

###SPI时钟速率

当我们驱动一些外设时，翻看数据手册或者产品说明页，能找到相应外设支持的最大时钟频率。

假定我们打算使用SPI1驱动外设，从设备允许的最大时钟频率为20MHz，怎么计算分频数是一个问题。这时候我们需要翻开芯片的数据手册（可以到立创商城搜索芯片型号找到），找到如下时钟树分配：

![F401部分时钟树](assets\F401部分时钟树.png)

在左半边可以看到SPI1挂载在APB2下，而APB2的最大速率为84MHz，分频数是2的幂有2/4/8/16等可选。那么**为了满足SPI1速率小于20MHz的需求，分频数至少为8，此时SPI1速率为10.5MHz**

##HAL库中SPI函数介绍

和串口通信类似，SPI的通信函数也是**HAL + 外设 + 动作**的方式定义，也有如下几个类型：

|      传输方向对比       |          功能          |
| :---------------------: | :--------------------: |
|    HAL_SPI_Transmit     |        发送数据        |
|     HAL_SPI_Receive     |        接收数据        |
| HAL_SPI_TransmitReceive | 全双工，接收和发送数据 |
|    **传输方式对比**     |                        |
|    HAL_SPI_Transmit     |        阻塞方式        |
|   HAL_SPI_Transmit_IT   |        中断方式        |
|  HAL_SPI_Transmit_DMA   |        DMA传输         |

可以看出SPI的传输协议的函数和串口的差别不大，都有**阻塞、中断、DMA**三种方式，但是不同的是SPI多了一个TransmitReceive函数，这是因为SPI是一个可以双工运行的协议，发送和接收可以同时进行。使用SPI通信时，设备的连线和串口不太一样，应保证名字相同的连在一起

具体SPI应用参考[OLED驱动移植](OLED驱动移植.md)