**CubeMX 配置IO口**

>在 CubeMX 中，先在Pinout View选择对应的IO口，然后在左侧System Core选择GPIO可以通过可视化的方式配置IO口的各种参数

在软件环境那的[教程](../软件环境/创建一个工程.md)那我们**设定一个了 GPIO 电平间歇性翻转**，简单配置板载 LED 对应的 IO 口。不过关于IO口配置的基本内容提及，相关知识在本章补充

#CubeMX中的配置

首先在主界面选择**File-->New Project**，或者直接点击**ACCEE TO MCU SELECTOR**。然后依次选择**MCU核心**、**MCU系列**和**MCU型号**。在日常做项目的过程中，可以根据此界面的各种信息轻松完成对MCU的选型。常见的信息有**Flash、ROM、封装和IO口等**。

本教程使用的是STM3F401CDU6，如图所示：
![CubeMX新建工程](assets\CubeMX新建工程.png)


成功新建工程之后接着我们来认识一下CubeMX的界面：
![CubeMX界面](assets\CubeMX界面.png)

最上面一行为不同的**设置界面**，分别为**引脚配置**、**时钟配置**、**项目管理**和**工具**。而第二行分为三部分，从左到右依次为**MCU外设资源选择**、**外设配置**和**预览界面**

每一次我们的项目都需要配置这些，本次也不例外。随着以后的教程的深入我们会逐步使用里面的外设。下面以点亮一个LED为例正式开始我们的教程学习。

**第一步**我们要做的是**配置下载**。如下图所示，在**引脚配置**界面下选择左侧**SYS**，然后在右侧MODE界面下的Debug一栏选择**Serial Wire**，其他设置默认。
![CubeMX配置下载](assets\CubeMX配置下载.png)

可以观察在右侧Pinout view下STM32对应的引脚图也发生了变化，SWDIO和SWCLK对应的PA13和PA14被点亮，而且颜色是**绿色**。这表明它们被**正确配置**。如果是**黄色**，表示你**配置了一个I/O口的功能，但是没有初始化相对应的外设功能,引脚处于no mode 状态** 。还有一种**浅黄色**，这种颜色表示**不可配置引脚**。  

**第二步**就需要配置时钟树。在此之前我们还需要在**引脚配置**界面配置外设晶振。选择左侧**RCC**，然后在右侧MODE界面下下的High Speed Clock(HSE)一栏选择Crystal/Ceramic Resonator（晶体/陶瓷谐振器）即可完成配置。同理右侧Pinout View中PH0和PH1会变为绿色。具体操作如下图所示：

![CubeMX配置时钟](assets\CubeMX配置时钟.png)

接下来点击最上面一行**时钟配置**，开始配置时钟树。首先先来介绍一下时钟树。时钟树由多个参数组成，可以根据需要调节。此外设置好输入频率（内部频率）后输入**主频**，按下**回车键**。软件可以自动调整分频系数和倍乘系数适应主频和其他总线的时钟频率。

![CubeMX时钟树](assets\CubeMX时钟树.png)

![CubeMX设置主频](assets\CubeMX设置主频.png)

完成这些就可以单片机的运行必备条件已经具备。

**第三步**所要做的是设置GPIO，准备点亮第一个LED。本教程中使用的LED连接的是PC13。点击最上面一行**引脚配置**，左键单击右侧Pinout view的PC13，选择**GPIO_Output**模式。PC13引脚也会变为绿色。

![CubeMX配置GPIO](assets\CubeMX配置GPIO.png)

点击最左侧**GPIO**,此时右侧Configuration界面可以设置GPIO的各种参数，点击PC13，引脚视图PC13引脚会闪烁。用户可以方便的在此界面调节各种参数，可以为引脚自定义设置名字，这为将来移植代码和更改引脚带来了方便，也增加代码可读性，为各模块之间的“代码去耦”提供了可能。此处我们不需要更改设置，保持默认即可。

![CubeMXGPIO参数](assets\CubeMXGPIO参数.png)

个性化更改用户名的另一种方法是右键单击引脚选择**Enter User Label**,然后输入即可。此处我们输入“LED”。

![CubeMX自定义名称](assets\CubeMX自定义名称.png)

以上三步我们就完成了所需硬件的配置，接下来是需要保存工程。

#生成工程详解

**第四步**点击最上面一行**项目管理**,依次设置项目名称、项目路径和工具链。这里工具链我们选择**Makefile**,项目名称和路径我们选择全英文，并且建议读者规范命名养成良好习惯。其他设置默认即可。

![CubeMX工程设置](assets\CubeMX工程设置.png)

补充一点STM32的内存结构。STM32的数据在物理上分别储存在**RAM**和**Flash**中。RAM可读可写，掉电清零。Flash可读可写，但是读写时间很长，能掉电储存，并且一般空间比RAM大很多。在关于如何使用RAM和Flash的问题上，STM32的内存又有了６个**储存数据段**和３种**储存属性区**的概念。

**data**：数据段，储存已初始化的，且初始化不为0的全局变量和静态变量。

**bss**：Block Started by Symbol。储存未初始化的，或初始化为0的全局变量和静态变量。

**text**：代码段，储存程序代码。

**constdata**：储存只读常量。

**heap**：堆，存放进程运行中被动态分配的内存段。其可用大小定义在启动文件startup_stm32fxx.s中，由程序员使用malloc()和free()函数进行分配和释放。

**stack**：栈，其大小定义在启动文件startup_stm32fxx.s中，由系统自动分配和释放。可存放局部变量、函数的参数和返回值，中断发生时能保存现场。但是static声明的局部静态变量不储存在栈中，而是放在data数据段。

**RO(Read Only)**：烧写到**Flash**中，可以长久保存。**text**代码段和**constdata**都属于**RO**。由于需要掉电储存，RO里也保存了一份**data**的数据。

**RW(Read Write)**：储存在**RAM**中。**data**属于此区。上电时单片机会将**Flash**中保存的**data**类型数据复制到**RAM**中，以供读写使用。

**ZI(Zero Init)**：零初始化区，同样储存在**RAM**里。系统上电时会把此区域的数据进行0初始化。**bss**，**heap**，**stack**均属于这个区域。

![STM32数据段和属性区](assets\STM32数据段和属性区.png)

接下来**第五步**是**代码创建设置**，选择如下图所示设置：

![CubeMX生成工程设置](assets\CubeMX生成工程设置.png)

完成以上设置后，点击右上角**generate**即可生成工程。

随后使用**Vscode**中的**EIDE**插件在主循环中加入如下代码：
```c
    HAL_GPIO_TogglePin(LED_GPIO_Port,LED_Pin);
    HAL_Delay(300);
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
```
所有自己编写的代码请放在/* USER CODE BEGIN XXX */　/* USER CODE END XXX */之间，这样我们修改工程的时候你自己写的代码就不会被删除。